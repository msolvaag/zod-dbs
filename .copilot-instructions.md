# GitHub Copilot Instructions for zod-pg

## Project Overview

This is **zod-pg**, a TypeScript tool that generates Zod schemas and TypeScript types from PostgreSQL database schemas. The tool introspects PostgreSQL databases and creates type-safe validation schemas to keep TypeScript code in sync with database structure.

## Core Architecture

### Main Components

- **CLI Tool**: Entry point for command-line usage (`src/cli.ts`)
- **Schema Generation**: Core logic in `src/generateZodSchemas.ts` and in `src/generate/`
- **Database Introspection**: PostgreSQL system catalog queries in `src/database/`
- **Template Engine**: Mustache templates in `templates/` for code generation
- **Type System**: TypeScript definitions in `src/types.ts`

### Key Technologies

- **PostgreSQL**: System catalogs (`pg_class`, `pg_attribute`, `pg_constraint`)
- **Mustache**: Template engine for generating TypeScript/Zod code
- **Node.js ESM**: ES modules with `import.meta.url` patterns
- **Vitest**: Testing framework with testcontainers for PostgreSQL

## Development Guidelines

### PostgreSQL Compatibility

- **Minimum Version**: PostgreSQL 9.3+ (uses LATERAL joins, JSON functions, materialized views)
- **System Catalogs**: Prefer `pg_class` over `information_schema` for complete feature support
- **Query Patterns**: Use parameterized queries with proper type casting

### Code Generation

- **Templates**: Located in `templates/` directory using Mustache syntax
- **Conditional Rendering**: Use `{{#condition}}...{{/condition}}` for optional sections
- **Spacing**: Place newlines inside Mustache blocks to avoid extra empty lines
- **Example**:

  ```mustache
  {{#hasTables}}

  export const tables = [{{#tables}}
    '{{name}}',{{/tables}}
  ];{{/hasTables}}
  ```

### File System Patterns

- **Path Handling**: Use `fileURLToPath(import.meta.url)` and `path.join()` for cross-platform compatibility
- **Template Loading**: Templates are loaded from `templates/` relative to package root using the `loadTemplate` utility in `src/generate/template.ts`.
- **Output Structure**: Generated files go to user-specified output directory with subfolders

### Testing Standards

- **Integration Tests**: Use testcontainers with PostgreSQL for real database testing
- **Unit Tests**: Mock database clients for isolated component testing
- **Snapshots**: Use Vitest snapshots for generated code validation
- **Test Database**: `test/integration/schema.sql` contains comprehensive test schema

### Type Safety

- **Zod Versions**: Support both Zod v3 and v4 with version-specific templates
- **PostgreSQL Types**: Map PostgreSQL data types to appropriate Zod validators
- **Enum Handling**: Extract enum constraints from CHECK constraints
- **Array Support**: Detect and handle PostgreSQL array types

## Common Patterns

### Database Connection

```typescript
import { Client } from 'pg';

const client = new Client(connectionConfig);
await client.connect();
try {
  const result = await client.query(sql`SELECT ...`, [params]);
  // Process result
} finally {
  await client.end();
}
```

### Template Rendering

```typescript
import { renderTemplate } from 'src/generate/template.js';

const content = await renderTemplate('table', templateData);
```

### Error Handling

- Use descriptive error messages with context
- Log debug information using `logDebug()` utility
- Validate input parameters early
- Handle PostgreSQL connection errors gracefully

## File Structure Context

```
src/
├── cli.ts              # Command-line interface
├── generateZodSchemas.ts # Main generation logic
├── types.ts            # TypeScript type definitions
├── database/           # PostgreSQL introspection
│   ├── schema.ts      # Main schema query logic
│   ├── typeMap.ts     # PostgreSQL to Zod type mapping
│   └── enumConstraints.ts # CHECK constraint parsing
├── generate/           # Code generation logic, models, formatters and utilities
└── utils/             # Shared utilities

templates/              # Mustache templates
├── index.mustache     # Schema exports
├── schema.mustache    # Main schema file for a table, view, materialized view or foreign table.
├── constants.mustache    # Constants
└── types.mustache     # TypeScript type exports

test/
├── integration/       # Database integration tests
│   ├── schema.sql    # Comprehensive test database
│   └── tests/        # Test suites
└── unit/             # Unit tests
```

## Development Tips

1. **Always check PostgreSQL version compatibility** when using system catalog features
2. **Test template changes** with the integration test database
3. **Use semantic search** to understand codebase patterns before making changes
4. **Validate generated code** with TypeScript compiler in tests
5. **Consider both ESM and CommonJS** module formats for compatibility
6. **Handle edge cases** like empty schemas, special characters in names
7. **Keep templates clean** by avoiding extra whitespace and proper conditional blocks

## Code Style

- Use TypeScript strict mode
- Prefer async/await over Promises
- Use template literals for SQL with `sql` tag function
- Keep functions focused and single-purpose
- Add JSDoc comments for public APIs
- Use descriptive variable names especially for database columns/tables
